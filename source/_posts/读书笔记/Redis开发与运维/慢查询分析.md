---
title: 慢查询分析
categories: 
- 读书笔记
- Redis开发与运维
---

如图所示，Redis客户端执行一条命令分为如下4个部分：

<img src="https://xiaoflyfish.oss-cn-beijing.aliyuncs.com/image/20210428020651.png" style="zoom:30%;" />

**需要注意，慢查询只统计步骤3的时间**，所以没有慢查询并不代表客户端没有超时问题

# 配置参数

> slowlog-log-slower-than

预设阀值，它的单位是微秒，默认值是1000，假如执行了一条**很慢**的命令（例如`keys *`），如果它的执行时间超过了1000微秒，那么它将被记录在慢查询日志中

`slowlog-log-slower-than=0`会记录所有的命令

`slowlog-log-slower-than<0`：对于任何命令都不会进行记录

> slowlog-max-len

说明了慢查询日志最多存储多少条，并没有说明存放在哪里实际上Redis使用了一个列表来存储慢查询日志，`slowlog-max-len`就是列表的最大长度

一个新的命令满足慢查询条件时被插入到这个列表中，当慢查询日志列表已处于其最大长度时，最早插入的一个命令将从列表中移出，例如`slowlog-max-len`设置为5，当有第6条慢查询插入的话，那么队头的第一条数据就出列，第6条慢查询就会入列

在Redis中有两种修改配置的方法，一种是修改配置文件，另一种是使用`config set`命令动态修改

例如下面使用`config set`命令将`slowlog-log-slower-than`设置为20000微秒，`slowlog-max-len`设置为1000：

```
config set slowlog-log-slower-than 20000
config set slowlog-max-len 1000
config rewrite
```

如果要Redis将配置持久化到本地配置文件，需要执行`config rewrite`命令

**获取慢查询日志**

```
slowlog get [n]
```

操作返回当前Redis的慢查询，参数n可以指定条数

**获取慢查询日志列表当前的长度**

```
slowlog len
```

**慢查询日志重置**

```
slowlog reset
```

实际是对列表做清理操作

# 最佳实践

> slowlog-max-len配置建议：

线上建议调大慢查询列表，记录慢查询时Redis会对长命令做截断操作，并不会占用大量内存。增大慢查询列表可以减缓慢查询被剔除的可能，例如线上可设置为1000以上

> slowlog-log-slower-than配置建议

默认值超过10毫秒判定为慢查询，需要根据Redis并发量调整该值

由于Redis采用单线程响应命令，对于高流量的场景，如果命令执行时间在1毫秒以上，那么Redis最多可支撑OPS不到1000，因此对于高OPS场景的Redis建议设置为1毫秒

**慢查询只记录命令执行时间，并不包括命令排队和网络传输时间**

由于慢查询日志是一个先进先出的队列，也就是说如果慢查询比较多的情况下，可能会丢失部分慢查询命令，为了防止这种情况发生，可以定期执行`slow get`命令将慢查询日志持久化到其他存储中（例如MySQL），然后可以制作可视化界面进行查询